YUI.add("album-route",(function(e){var t=require("hermes-core/type-validator"),a=50,r=100;function o(e){o.superclass.constructor.call(this,e)}e.Routes[this.name]=o,e.extend(o,e.FlickrRoute,{langBundles:this.details.langBundles,run:function(o){var i,s,n,l=this,u={},p="/photos/"+o.params.nsid_or_path_alias+"/albums/"+o.params.set_id+"/",d=o.params&&o.params.photo_id,g=d?r:25,m=this.getPageNumber(o),h=!!o.headers&&o.headers["user-agent"],c=o.query?o.query:{},f=!1,b=o.params.nsid_or_path_alias,P=[];return h&&null!==h.match(/^Twitterbot/i)&&(f=!0),u.id=o.params.set_id,i={page:r/g*(m-1)+1,perPage:g,withPhotoId:d},P.push(this.appContext.getModel("set-models",u,i)),this.appContext.getViewer().signedIn||o.probableUser?P.push(this.appContext.getModel("person-preferences-models",this.appContext.getViewer().signedIn?this.appContext.getViewer().nsid:o.probableUser)):s=c.layout?c.layout:"story",e.Promise.all(P).catch((function(e){if(e.getModelFailure&&o.probableUser)return o.probableUser=null,[];throw e})).then((function(u){var g=0,h=u[0];if(u[1]&&(s=u[1].getValue("albumViewLayoutPref")),YUI.Env.isServer&&(g=Math.ceil(h.getValue("totalCount")/r),m>g&&i.page>1&&!isNaN(parseInt(o.params.page_number,10))))return e.Promise.resolve({redirect:p.replace(/page[0-9]+/,"")});if(b!==h.getValue("owner").getValue(t.nsid(b)?"id":"pathAlias"))return l.onRouteRejected({message:"Album "+h.getValue("id")+" is not owned by "+b},o);if(d){var c=h.getValue("photoPageList");if(-1===(n=c.getPageOf({id:d},a))||c.getNextIncompletePage(i)===n)return i.forceAPICall=!0,c.getPage(i).then((function(e){return-0===(m=Math.ceil(c.getPageOf({id:d},a)*a/r))&&(m=0),n=m,l.onRouteResolved(h,m,n,p,d,f,s,b)}),(function(e){return 2===e.code?(m=l.getPageNumber(o),n=2*(m-1)+1,l.onRouteResolved(h,m,n,p,d,f,s,b)):l.onRouteRejected(e,o)}));m=Math.ceil(c.getPageOf({id:d},a)*a/r),n=m}else n=2*(m-1)+1;return l.onRouteResolved(h,m,n,p,d,f,s,b)})).catch((function(t){if(2===t.code)return e.Promise.resolve({redirect:p});if(t.timeout){return e.Promise.resolve({view:"empty-album-page-view",layout:"scrolling",params:{}})}return l.onRouteRejected(t,o)}))},onRouteResolved:function(t,o,i,s,n,l,u,p){var d={idAttribute:"id",page:i,perPage:n?r:a,viewPageSizeForShare:r,nominalPage:o};return this.appContext.flipper.isFlipped("enable-album-pagination")&&(d.viewPageSize=r),e.Promise.resolve({view:"album-page-view",layout:"scrolling",title:t.getValue("title"),params:{albumId:t.id,nsid:t.getValue("owner").getValue("nsid"),baseURL:s,isTwitterbot:l,albumPhotoListLayoutStyle:u,withPhotoId:n,nsidOrPathAlias:p,pageParams:d}})},onRouteRejected:function(t,a){if(t.fatal)throw t;return this.appContext.getViewer().signedIn?this.displayRouteErrors(a,new e.RouteError(404,this.intlMessage({intlName:"common.404_ALBUM_NONEXISTENT"}),{modelType:"sets-models",modelID:this.getNSIDOrPathAlias(a.params.nsid_or_path_alias)})):this.displayRouteErrors(a,new e.RouteError(403,this.intlMessage({intlName:"common.404_ALBUM_PRIVATE"})))}}),e.mix(o.prototype,e.Localizable)}),"@VERSION@",{requires:["flickr-route","flickr-promise","set-models","person-preferences-models"],optionalRequires:["hermes-core"],langBundles:["common"]});